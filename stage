#!/usr/bin/env bash
set -euo pipefail

# constants
# To-do don't hardcode source env file
source "/srv/docker/ci_runner/config.env"
readonly CI_DIR="${WORKING_DIR}"
readonly BUILD_DIR="$CI_DIR/builders"
readonly DEF_STAGING_DIR="${DEFAULT_STAGE}"
readonly DEF_BUILDER="${DEFAULT_BUILDER}"
readonly CORE="$CI_DIR/core"

usage() {
  echo "Usage: stage <project_dir> [update_type] [builder_type] [staging_dir]" >&2
}

# args
if [[ $# -lt 2 || $# -gt 4 ]]; then
  usage
  exit 1
fi

readonly SOURCE_PATH="$1"
readonly UPDATE_TYPE="$2"
readonly BUILDER="${3:-$DEF_BUILDER}"
readonly STAGING_DIR="${4:-$DEF_STAGING_DIR}"
readonly SIG_PASS="${SIG_PASS}"

if [[ ! -d "$SOURCE_PATH" ]]; then
  echo "Source project directory not found: $SOURCE_PATH" >&2
  exit 1
fi

readonly PROJECT_NAME="$(basename -- "$SOURCE_PATH")"
readonly SRC_DIR="$CI_DIR/src"
readonly OUT_DIR="$CI_DIR/out"


# echo "Updating main branch with new packages..."
# git -C $STAGING_DIR checkout main
# git -C $STAGING_DIR pull origin main

# echo "Switching to staging branch..."
# if git -C $STAGING_DIR rev-parse --verify --quiet refs/heads/staging; then
#   git -C $STAGING_DIR checkout staging
# else
#   echo "Local staging branch does not exist. Creating it."
#   git -C $STAGING_DIR checkout -b staging
# fi

echo "Preparing stage..."
mkdir -p "$SRC_DIR" "$OUT_DIR" "$STAGING_DIR"
rm -rf -- "$SRC_DIR"/* || true
rm -rf -- "$OUT_DIR"/* || true

echo "Staging..."
cp -a -- "$SOURCE_PATH" "$SRC_DIR/"

# docker compose controls
compose_up() {
  docker-compose -f "$BUILD_DIR/$BUILDER-builder.yml" up --abort-on-container-exit --exit-code-from "$BUILDER"_builder
}

compose_down() {
  docker-compose -f "$BUILD_DIR/$BUILDER-builder.yml" down -v 
}
trap compose_down EXIT

# run builder
echo "Running builder..."
echo " $BUILDER..." >&2
if ! compose_up ; then
  echo "Failed to build project $PROJECT_NAME" >&2
  exit 1
fi
trap - EXIT
compose_down || true
echo "Successfully built $PROJECT_NAME."


# update metadata w/ stage.py
echo "Updating metadata..."
PY_OUTPUT=""
if ! PY_OUTPUT=$(/bin/python3 "$CORE/stage.py" "$PROJECT_NAME" "$UPDATE_TYPE" -b "$BUILDER" 2>&1); then
  echo "$PY_OUTPUT" >&2
  echo "Failed to update $PROJECT_NAME metadata" >&2
  exit 1
fi

# stage.py prints an informational line and then the package name on the last line
readonly PKG_NAME="$(printf '%s' "$PY_OUTPUT" | tail -n 1)"


# arrange outputs
echo "Moving to stage..."
readonly PROJECT_OUT_DIR="$OUT_DIR/$PROJECT_NAME"
mkdir -p "$PROJECT_OUT_DIR"
readonly METADATA_FILE="$OUT_DIR/${PKG_NAME}_md.json"
if [[ -f "$METADATA_FILE" ]]; then
  mv -f -- "$METADATA_FILE" "$PROJECT_OUT_DIR/metadata.json"
fi

# Compress results
echo "Compressing..."
readonly TARBALL="$OUT_DIR/${PKG_NAME}.tar.gz"
(
  cd "$OUT_DIR" >/dev/null
  tar -czf "$TARBALL" "$PROJECT_NAME"
)

echo "Creating signature..."
echo "$SIG_PASS" | minisign -S \
  -s "$CI_DIR/ci.key" \
  -m "$TARBALL"

echo "Creating sha256 hash..."
SHA256=$(sha256sum "$TARBALL" | awk '{print $1}')
echo "$SHA256" > "$TARBALL.sha256"


# sync to staging
echo "Syncing signature..." || true
if ! rsync -a --exclude '.git' -- "$TARBALL.minisig" "$STAGING_DIR/$PROJECT_NAME/signatures"; then
  echo "rsync failed, attempting fallback copy" >&2
  mkdir -p "$STAGING_DIR/$PROJECT_NAME"
  if ! cp -a -- "$TARBALL.minisig" "$STAGING_DIR/$PROJECT_NAME/signatures"; then
    echo "Failed to move signature to staging directory" >&2
    exit 1
  fi
fi
echo "Successfully synced signature" || true
echo "Syncing sha256..." || true
if ! rsync -a --exclude '.git' -- "$TARBALL.sha256" "$STAGING_DIR/$PROJECT_NAME/signatures"; then
  echo "rsync failed, attempting fallback copy" >&2
  mkdir -p "$STAGING_DIR/$PROJECT_NAME"
  if ! cp -a -- "$TARBALL.sha256" "$STAGING_DIR/$PROJECT_NAME/signatures"; then
    echo "Failed to move sha256 to staging directory" >&2
    exit 1
  fi
fi
echo "Successfully synced sha256" || true
echo "Syncing artifacts..." || true
if ! rsync -a --exclude '.git' -- "$TARBALL" "$STAGING_DIR/$PROJECT_NAME/"; then
  echo "rsync failed, attempting fallback copy" >&2
  mkdir -p "$STAGING_DIR/$PROJECT_NAME"
  if ! cp -a -- "$TARBALL" "$STAGING_DIR/$PROJECT_NAME/"; then
    echo "Failed to move files to staging directory" >&2
    exit 1
  fi
fi
echo "Successfully synced artifacts" || true

# attempt to normalize ownership
if id -u 1000 >/dev/null 2>&1; then
  chown -R 1000:1000 "$STAGING_DIR" || true
fi

# echo "Pushing to github repo..."

# git -C $STAGING_DIR add .
# git -C $STAGING_DIR commit -m "Staging $PROJECT_NAME"
# git -C $STAGING_DIR push -f origin staging


echo "Successfully staged $PROJECT_NAME" || true
